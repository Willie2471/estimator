<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Landscaping Cost Estimator</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script>
    // Callback for when Google Maps API loads
    function onGoogleMapsLoaded() {
      console.log('Google Maps API loaded successfully');
    }
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBHvZq7kiDX_thzi8F9XTg_bySLcxpd_ME&libraries=drawing,geometry,places&callback=onGoogleMapsLoaded"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    body {
      font-family: 'Space Mono', 'Courier New', monospace;
      background: #f5f5f5;
      padding: 20px;
      color: #2c3e50;
      margin: 0;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e0e0e0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .header {
      background: linear-gradient(90deg, #2ecc71 0%, #27ae60 100%);
      padding: 32px;
      border-bottom: 1px solid #27ae60;
      color: #ffffff;
    }

    .header h1 {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 8px;
      color: #ffffff;
    }

    .header p {
      opacity: 0.95;
      font-size: 14px;
      letter-spacing: 0.5px;
      color: #ffffff;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: #e0e0e0;
    }

    .left-panel {
      background: #ffffff;
      padding: 32px;
    }

    .right-panel {
      background: #fafafa;
      padding: 32px;
    }

    .section {
      margin-bottom: 32px;
    }

    .section h2 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
      color: #27ae60;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    input, select {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 12px;
      background: #ffffff;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      color: #2c3e50;
      font-size: 14px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      border-color: #27ae60;
    }

    input::placeholder {
      color: #95a5a6;
      opacity: 0.8;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      opacity: 0.9;
      color: #2c3e50;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid #e0e0e0;
      transition: all 0.2s;
      background: #ffffff;
    }

    .checkbox-label.active {
      background: #e8f5e9;
      border-color: #27ae60;
    }

    .info-box {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .info-box h3 {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 16px;
      color: #27ae60;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
      color: #2c3e50;
    }

    .info-row span:first-child {
      opacity: 0.7;
    }

    .info-row span:last-child {
      font-weight: 600;
    }

    .divider {
      border-top: 2px solid #e0e0e0;
      margin: 12px 0;
      padding-top: 12px;
    }

    .price-box {
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 24px;
      border: 2px solid;
    }

    .price-box.success {
      background: #e8f5e9;
      border-color: #27ae60;
    }

    .price-box.warning {
      background: #fff3e0;
      border-color: #f39c12;
    }

    .price-box h3 {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .big-price {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .price-box.success .big-price,
    .price-box.success h3 {
      color: #27ae60;
    }

    .price-box.warning .big-price,
    .price-box.warning h3 {
      color: #f39c12;
    }

    .status-badge {
      font-size: 12px;
      opacity: 0.9;
      padding: 12px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 6px;
      margin-bottom: 12px;
      color: #2c3e50;
    }

    button {
      width: 100%;
      padding: 16px;
      background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%);
      border: none;
      border-radius: 8px;
      color: #ffffff;
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
    }

    button:hover {
      background: linear-gradient(90deg, #2ecc71 0%, #27ae60 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      opacity: 0.5;
      color: #7f8c8d;
    }

    .footer {
      background: #f8f9fa;
      padding: 16px 32px;
      border-top: 1px solid #e0e0e0;
      text-align: center;
      font-size: 12px;
      opacity: 0.7;
      color: #7f8c8d;
    }

    @media (max-width: 968px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Google Places Autocomplete styling */
    .pac-container {
      font-family: 'Space Mono', 'Courier New', monospace !important;
      border-radius: 8px;
      margin-top: 4px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border: 2px solid #e0e0e0;
      z-index: 99999 !important;
      position: absolute !important;
      display: block !important;
      visibility: visible !important;
      background: white !important;
    }

    .pac-item {
      padding: 10px;
      font-size: 13px;
      border-top: 1px solid #e0e0e0;
      cursor: pointer;
      background: white;
      display: block !important;
    }

    .pac-item:hover {
      background-color: #f0f0f0 !important;
    }

    .pac-item-query {
      font-size: 14px;
      color: #2c3e50;
      font-weight: 600;
    }

    .pac-icon {
      display: none;
    }
    
    /* Ensure pac-container is not hidden by any parent overflow */
    body .pac-container {
      display: block !important;
    }

    /* Style the "powered by Google" logo to attach to bottom of dropdown */
    .pac-container::after {
      content: '';
      display: block;
      height: 0;
    }

    .pac-logo::after {
      display: block !important;
      text-align: right !important;
      padding: 8px 10px !important;
      background: #f8f8f8 !important;
      border-top: 1px solid #e0e0e0 !important;
      border-radius: 0 0 6px 6px !important;
    }

    /* Style any Google branding that appears */
    .pac-container + div {
      position: relative !important;
      margin-top: 0 !important;
      background: #f8f8f8 !important;
      padding: 8px 10px !important;
      border: 2px solid #e0e0e0 !important;
      border-top: none !important;
      border-radius: 0 0 8px 8px !important;
    }

    .hdpi.pac-logo::after,
    div[style*="powered"] {
      background: #f8f8f8 !important;
      padding: 8px !important;
      text-align: right !important;
    }

    /* Profit margin slider styling */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #27ae60;
      cursor: pointer;
      border: 3px solid white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: all 0.2s ease;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      background: #2ecc71;
      transform: scale(1.1);
    }

    input[type="range"]::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #27ae60;
      cursor: pointer;
      border: 3px solid white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: all 0.2s ease;
    }

    input[type="range"]::-moz-range-thumb:hover {
      background: #2ecc71;
      transform: scale(1.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="display: flex; align-items: center; gap: 20px; justify-content: center;">
        <img src="https://static.wixstatic.com/media/99a075_f0b64d954a90417ba2ac87c06f85804a~mv2.png" alt="WS Lawn Care Services" style="height: 80px; width: auto; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.2));">
        <div>
          <h1 style="margin-bottom: 8px;">Landscaping Cost Estimator</h1>
          <p style="margin: 0;">Professional project estimation & job costing</p>
        </div>
      </div>
    </div>

    <div class="main-grid">
      <!-- LEFT PANEL -->
      <div class="left-panel">
        <!-- Project Details -->
        <div class="section">
          <h2>üìã Project Details</h2>
          <input type="text" id="projectName" placeholder="Project Name">
          <input type="text" id="propertyAddress" placeholder="Property Address">
          <input type="text" id="projectType" placeholder="Project Type">
        </div>

        <!-- Material Selection -->
        <div class="section">
          <h2>üì¶ Material Selection</h2>
          <select id="materialCategory">
            <option value="mulch">Mulch</option>
            <option value="rock">Decorative Rock</option>
            <option value="dirt">Dirt/Soil</option>
            <option value="sod">Sod</option>
          </select>
          <select id="materialType"></select>
        </div>

        <!-- Additional Materials -->
        <div class="section">
          <h2>üì¶ Additional Materials</h2>
          <div id="additionalMaterialsContainer"></div>
          <button onclick="addMaterialRow()" style="width: 100%; padding: 10px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 8px;">
            ‚ûï Add Material Row
          </button>
        </div>

        <!-- Google Maps Measurement -->
        <div class="section">
          <h2>üó∫Ô∏è Google Maps Measurement</h2>
          <button id="toggleMapBtn" style="width: 100%; padding: 12px; background: #27ae60; color: white; border: 2px solid #27ae60; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 12px;">
            üìç Open Map to Measure
          </button>
          <div id="mapContainer" style="display: none;">
            <div style="margin-bottom: 12px; position: relative;">
              <input 
                id="addressSearch" 
                type="text" 
                placeholder="Start typing address... (suggestions will appear)"
                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit; font-size: 14px; position: relative;"
                onkeypress="if(event.key === 'Enter') searchAddress()"
                autocomplete="off"
              />
              <div style="font-size: 11px; color: #7f8c8d; margin-top: 4px; padding-left: 4px;">
                üí° Type address - suggestions appear automatically
              </div>
              <button 
                onclick="searchAddress()" 
                style="width: 100%; margin-top: 8px; padding: 10px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                üîç Search Address
              </button>
            </div>
            <div id="map" style="width: 100%; height: 400px; border-radius: 8px; border: 2px solid #e0e0e0; margin-bottom: 12px;"></div>
            <div id="measurementsDisplay" style="background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 12px; display: none;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 2px solid #e0e0e0;">
                <strong style="color: #2c3e50;">Measurements (<span id="measurementCount">0</span>)</strong>
                <button onclick="clearAllMeasurements()" style="padding: 6px 12px; background: #e74c3c; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">
                  Clear All
                </button>
              </div>
              <div id="measurementsList"></div>
              <div style="margin-top: 12px; padding-top: 12px; border-top: 2px solid #e0e0e0; font-weight: 700; color: #2c3e50;">
                <div>Total Area: <span id="totalArea">0</span> sq ft</div>
                <div>Total Perimeter: <span id="totalPerimeter">0</span> ft</div>
              </div>
              <button onclick="applyMeasurements()" style="width: 100%; margin-top: 12px; padding: 10px 16px; background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%); border: none; border-radius: 6px; color: white; font-size: 13px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);">
                ‚ûú Apply to Dimensions Below
              </button>
            </div>
            <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; padding: 12px; font-size: 12px; color: #1976d2;">
              <strong>üìå How to use:</strong>
              <ul style="margin: 8px 0 0 20px; line-height: 1.6;">
                <li>Start typing address - suggestions will appear automatically</li>
                <li>Select from dropdown or press Enter to search</li>
                <li>Use drawing tools to trace property boundaries</li>
                <li>Draw multiple areas - they'll be totaled automatically</li>
                <li>Click "Apply to Dimensions Below" to transfer measurements</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Dimensions -->
        <div class="section">
          <h2>üìê Dimensions</h2>
          <div id="dimensionsContainer"></div>
        </div>

        <!-- Add-ons -->
        <div class="section">
          <h2>‚ûï Add-ons</h2>
          <label class="checkbox-label" id="geoTextileLabel">
            <input type="checkbox" id="includeGeoTextile">
            <span>Geo Textile Fabric ($1.20/ft)</span>
          </label>
          <input type="number" id="geoTextileLinearFt" placeholder="Linear feet" style="display:none;">

          <label class="checkbox-label" id="edgingLabel">
            <input type="checkbox" id="includeEdging">
            <span>Composite Edging ($5.00/ft)</span>
          </label>
          <input type="number" id="edgingLinearFt" placeholder="Linear feet" style="display:none;">
        </div>

        <!-- Equipment -->
        <div class="section">
          <h2>üîß Equipment</h2>
          <div id="equipmentContainer"></div>
          <button onclick="addEquipmentRow()" style="width: 100%; padding: 10px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 8px;">
            ‚ûï Add Equipment Row
          </button>
        </div>

        <!-- Labor & Costs -->
        <div class="section">
          <h2>üíµ Labor & Additional Costs</h2>
          <div class="grid-2">
            <div>
              <label>Labor Hours</label>
              <input type="number" id="laborHours" placeholder="0">
            </div>
            <div>
              <label>Rate ($/hr)</label>
              <input type="number" id="laborRate" value="91">
            </div>
          </div>

          <div class="grid-2">
            <div>
              <label>Delivery Fee</label>
              <input type="number" id="deliveryFee" placeholder="0">
            </div>
            <div>
              <label>Haul Away</label>
              <input type="number" id="haulAway" placeholder="0">
            </div>
          </div>

          <div>
            <label>Markup (%)</label>
            <input type="number" id="markupPercent" value="0">
          </div>

          <div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #e0e0e0;">
            <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <span style="font-weight: 700; color: #27ae60;">üéØ Target Profit Margin</span>
              <span id="profitMarginDisplay" style="font-size: 20px; font-weight: 700; color: #27ae60;">40%</span>
            </label>
            <input 
              type="range" 
              id="profitMarginSlider" 
              min="0" 
              max="100" 
              value="40" 
              step="1"
              style="width: 100%; height: 8px; border-radius: 4px; background: linear-gradient(90deg, #e74c3c 0%, #f39c12 25%, #27ae60 40%, #2ecc71 100%); cursor: pointer; -webkit-appearance: none; appearance: none;"
            >
            <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: #7f8c8d;">
              <span>0%</span>
              <span>25%</span>
              <span>50%</span>
              <span>75%</span>
              <span>100%</span>
            </div>
            <div style="margin-top: 12px; padding: 12px; background: #e8f5e9; border-radius: 6px; font-size: 12px; color: #2c3e50;">
              üí° <strong>Tip:</strong> 40% is your target. The calculation automatically accounts for 3% CC fees.
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT PANEL -->
      <div class="right-panel">
        <h2>üìä Estimate Summary</h2>
        <div id="summaryContent"></div>
      </div>
    </div>

    <div class="footer">
      Professional landscaping estimator ‚Ä¢ Integrated material cost database & job costing
    </div>
  </div>

  <script>
    // Google Maps variables
    let map = null;
    let drawingManager = null;
    let mapMeasurements = [];
    let locationMarker = null; // Persistent red marker for searched location
    
    // Equipment and material rows
    let equipmentRows = [];
    let additionalMaterialRows = [];
    
    // Material pricing data
    const MATERIALS = {
      mulch: [
        { name: 'Pine Bark', pricePerYard: 34, pricePerHalf: 17 },
        { name: 'Brown Mulch', pricePerYard: 34, pricePerHalf: 17 },
        { name: 'Red Mulch', pricePerYard: 34, pricePerHalf: 17 },
        { name: 'Chocolate Mulch', pricePerYard: 34, pricePerHalf: 17 }
      ],
      rock: [
        { name: '2" Granite', pricePerYard: 170, pricePerHalf: 85 },
        { name: '3/4" Brown Pea Stone', pricePerYard: 180, pricePerHalf: 90 },
        { name: '1.5" Brown River Rock', pricePerYard: 220, pricePerHalf: 110 },
        { name: '1-3" Brown River Rock', pricePerYard: 230, pricePerHalf: 115 },
        { name: 'Red Lava Rock', pricePerYard: 230, pricePerHalf: 115 }
      ],
      dirt: [
        { name: 'Fill Dirt/Top Soil', pricePerYard: 40, pricePerHalf: 20 }
      ],
      sod: [
        { name: 'Argentine Bahia', pricePerPallet: 170.5, pricePerSqFt: 0.42625 },
        { name: 'St. Augustine Floratam', pricePerPallet: 239.91, pricePerSqFt: 0.599775 },
        { name: 'St. Augustine Pro Vista', pricePerPallet: 313.74, pricePerSqFt: 0.78435 },
        { name: 'St. Augustine Citra Blue', pricePerPallet: 292.34, pricePerSqFt: 0.73085 },
        { name: 'Icon Zoysia', pricePerPallet: 313.74, pricePerSqFt: 0.78435 }
      ]
    };

    const ADDONS = {
      geoTextile: { name: 'Geo Textile Fabric', pricePerLinearFt: 1.20 },
      edging: { name: 'Composite Edging', pricePerLinearFt: 5.00 }
    };

    // DOM elements
    const materialCategory = document.getElementById('materialCategory');
    const materialType = document.getElementById('materialType');
    const dimensionsContainer = document.getElementById('dimensionsContainer');
    const includeGeoTextile = document.getElementById('includeGeoTextile');
    const geoTextileLinearFt = document.getElementById('geoTextileLinearFt');
    const includeEdging = document.getElementById('includeEdging');
    const edgingLinearFt = document.getElementById('edgingLinearFt');
    const summaryContent = document.getElementById('summaryContent');

    // Initialize
    function init() {
      updateMaterialOptions();
      updateDimensionsInputs();
      initializeEquipmentRows();
      initializeAdditionalMaterials();
      initializeGoogleMaps();
      
      // Event listeners
      materialCategory.addEventListener('change', () => {
        updateMaterialOptions();
        updateDimensionsInputs();
        calculate();
      });

      materialType.addEventListener('change', calculate);

      includeGeoTextile.addEventListener('change', (e) => {
        geoTextileLinearFt.style.display = e.target.checked ? 'block' : 'none';
        document.getElementById('geoTextileLabel').classList.toggle('active', e.target.checked);
        calculate();
      });

      includeEdging.addEventListener('change', (e) => {
        edgingLinearFt.style.display = e.target.checked ? 'block' : 'none';
        document.getElementById('edgingLabel').classList.toggle('active', e.target.checked);
        calculate();
      });

      // Profit margin slider
      const profitMarginSlider = document.getElementById('profitMarginSlider');
      const profitMarginDisplay = document.getElementById('profitMarginDisplay');
      
      if (profitMarginSlider && profitMarginDisplay) {
        profitMarginSlider.addEventListener('input', (e) => {
          profitMarginDisplay.textContent = e.target.value + '%';
          calculate();
        });
      }

      // Add input listeners for all inputs
      document.querySelectorAll('input, select').forEach(el => {
        el.addEventListener('input', calculate);
      });

      calculate();
    }

    function updateMaterialOptions() {
      const category = materialCategory.value;
      const materials = MATERIALS[category];
      
      materialType.innerHTML = materials.map(m => {
        const price = category === 'sod' 
          ? `$${m.pricePerSqFt.toFixed(2)}/sq ft`
          : `$${m.pricePerYard}/yard`;
        return `<option value="${m.name}">${m.name} - ${price}</option>`;
      }).join('');
    }

    function updateDimensionsInputs() {
      const category = materialCategory.value;
      
      if (category === 'sod') {
        dimensionsContainer.innerHTML = `
          <label>Square Feet</label>
          <input type="number" id="sqFt" placeholder="Enter square feet">
        `;
      } else {
        dimensionsContainer.innerHTML = `
          <div class="grid-2">
            <div>
              <label>Length (ft)</label>
              <input type="number" id="length" placeholder="0">
            </div>
            <div>
              <label>Width (ft)</label>
              <input type="number" id="width" placeholder="0">
            </div>
          </div>
          <label>Depth (inches)</label>
          <input type="number" id="depth" value="1">
        `;
      }

      // Re-attach listeners
      dimensionsContainer.querySelectorAll('input').forEach(el => {
        el.addEventListener('input', calculate);
      });
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2
      }).format(value || 0);
    }

    // Initialize equipment rows (start with 0, user adds as needed)
    function initializeEquipmentRows() {
      // Start with no rows - user can add as needed
    }

    // Add equipment row
    function addEquipmentRow() {
      const container = document.getElementById('equipmentContainer');
      const id = Date.now() + Math.random();
      
      const rowDiv = document.createElement('div');
      rowDiv.id = `equipment-${id}`;
      rowDiv.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr auto; gap: 8px; margin-bottom: 8px;';
      rowDiv.innerHTML = `
        <input type="text" placeholder="Equipment description" class="equipment-desc" data-id="${id}" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-family: inherit;">
        <input type="number" placeholder="Cost" class="equipment-cost" data-id="${id}" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-family: inherit;">
        <button onclick="removeEquipmentRow('${id}')" style="padding: 10px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer;">‚úï</button>
      `;
      
      container.appendChild(rowDiv);
      equipmentRows.push({ id, description: '', cost: 0 });
      
      // Add event listeners
      rowDiv.querySelector('.equipment-desc').addEventListener('input', (e) => {
        const row = equipmentRows.find(r => r.id == id);
        if (row) row.description = e.target.value;
        calculate();
      });
      
      rowDiv.querySelector('.equipment-cost').addEventListener('input', (e) => {
        const row = equipmentRows.find(r => r.id == id);
        if (row) row.cost = parseFloat(e.target.value) || 0;
        calculate();
      });
    }

    // Remove equipment row
    function removeEquipmentRow(id) {
      const element = document.getElementById(`equipment-${id}`);
      if (element) element.remove();
      equipmentRows = equipmentRows.filter(r => r.id != id);
      calculate();
    }

    // Initialize additional materials
    function initializeAdditionalMaterials() {
      // Start with no rows - user can add as needed
    }

    // Add material row
    function addMaterialRow() {
      const container = document.getElementById('additionalMaterialsContainer');
      const id = Date.now() + Math.random();
      
      const rowDiv = document.createElement('div');
      rowDiv.id = `material-${id}`;
      rowDiv.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr auto; gap: 8px; margin-bottom: 8px;';
      rowDiv.innerHTML = `
        <input type="text" placeholder="Material description" class="material-desc" data-id="${id}" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-family: inherit;">
        <input type="number" placeholder="Cost" class="material-cost" data-id="${id}" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-family: inherit;">
        <button onclick="removeMaterialRow('${id}')" style="padding: 10px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer;">‚úï</button>
      `;
      
      container.appendChild(rowDiv);
      additionalMaterialRows.push({ id, description: '', cost: 0 });
      
      // Add event listeners
      rowDiv.querySelector('.material-desc').addEventListener('input', (e) => {
        const row = additionalMaterialRows.find(r => r.id == id);
        if (row) row.description = e.target.value;
        calculate();
      });
      
      rowDiv.querySelector('.material-cost').addEventListener('input', (e) => {
        const row = additionalMaterialRows.find(r => r.id == id);
        if (row) row.cost = parseFloat(e.target.value) || 0;
        calculate();
      });
    }

    // Remove material row
    function removeMaterialRow(id) {
      const element = document.getElementById(`material-${id}`);
      if (element) element.remove();
      additionalMaterialRows = additionalMaterialRows.filter(r => r.id != id);
      calculate();
    }

    // Initialize Google Maps
    function initializeGoogleMaps() {
      const toggleBtn = document.getElementById('toggleMapBtn');
      const mapContainer = document.getElementById('mapContainer');
      
      toggleBtn.addEventListener('click', () => {
        const isVisible = mapContainer.style.display !== 'none';
        mapContainer.style.display = isVisible ? 'none' : 'block';
        toggleBtn.textContent = isVisible ? 'üìç Open Map to Measure' : '‚úì Map Active - Click to Hide';
        toggleBtn.style.background = isVisible ? '#27ae60' : '#2ecc71';
        
        if (!isVisible && !map) {
          // Check if Google Maps API is loaded
          if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
            alert('Google Maps is still loading. Please wait a moment and try again.');
            mapContainer.style.display = 'none';
            toggleBtn.textContent = 'üìç Open Map to Measure';
            toggleBtn.style.background = '#27ae60';
            return;
          }
          initMap();
        }
      });
    }

    // Initialize the Google Map
    function initMap() {
      if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
        console.error('Google Maps API not loaded');
        alert('Google Maps failed to load. Please refresh the page.');
        return;
      }

      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 28.6139, lng: -80.8075 }, // Titusville, FL
        zoom: 18,
        mapTypeId: 'satellite',
        tilt: 0
      });

      drawingManager = new google.maps.drawing.DrawingManager({
        drawingMode: google.maps.drawing.OverlayType.POLYGON,
        drawingControl: true,
        drawingControlOptions: {
          position: google.maps.ControlPosition.TOP_CENTER,
          drawingModes: [
            google.maps.drawing.OverlayType.POLYGON,
            google.maps.drawing.OverlayType.RECTANGLE
          ]
        },
        polygonOptions: {
          fillColor: '#27ae60',
          fillOpacity: 0.3,
          strokeWeight: 2,
          strokeColor: '#27ae60',
          editable: true
        },
        rectangleOptions: {
          fillColor: '#27ae60',
          fillOpacity: 0.3,
          strokeWeight: 2,
          strokeColor: '#27ae60',
          editable: true
        }
      });

      drawingManager.setMap(map);

      // Initialize Google Places Autocomplete for address search
      const addressInput = document.getElementById('addressSearch');
      
      if (!addressInput) {
        console.error('Address search input not found');
        return;
      }

      try {
        const autocomplete = new google.maps.places.Autocomplete(addressInput, {
          types: ['address'],
          componentRestrictions: { country: 'us' },
          fields: ['geometry', 'formatted_address']
        });

        // Bias results to Brevard County, FL area
        autocomplete.setBounds({
          north: 28.7,
          south: 27.9,
          east: -80.4,
          west: -80.9
        });

        // Listen for place selection from autocomplete
        autocomplete.addListener('place_changed', () => {
          const place = autocomplete.getPlace();
          
          if (!place.geometry) {
            console.log('No geometry for place');
            return;
          }
          
          // Auto-fill property address in Project Details
          const propertyAddressInput = document.getElementById('propertyAddress');
          if (propertyAddressInput && place.formatted_address) {
            propertyAddressInput.value = place.formatted_address;
          }
          
          map.setCenter(place.geometry.location);
          map.setZoom(19);
          
          // Remove old location marker if exists
          if (locationMarker) {
            locationMarker.setMap(null);
          }
          
          // Add persistent RED marker at the searched location
          locationMarker = new google.maps.Marker({
            map: map,
            position: place.geometry.location,
            animation: google.maps.Animation.DROP,
            icon: {
              url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
            },
            title: place.formatted_address || 'Property Location'
          });
        });
        
        console.log('Autocomplete initialized successfully');
        
        // Fix dropdown position in iframe and attach Google logo
        const observer = new MutationObserver(() => {
          const pacContainers = document.querySelectorAll('.pac-container');
          
          pacContainers.forEach(container => {
            if (container && addressInput) {
              const rect = addressInput.getBoundingClientRect();
              const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
              const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
              
              container.style.top = (rect.bottom + scrollTop + 2) + 'px';
              container.style.left = (rect.left + scrollLeft) + 'px';
              container.style.width = rect.width + 'px';
              container.style.position = 'absolute';
            }
          });
          
          // Find and position the "powered by Google" logo
          const pacLogos = document.querySelectorAll('.pac-logo::after, img[src*="powered_by_google"]');
          pacLogos.forEach(logo => {
            if (pacContainers.length > 0) {
              const container = pacContainers[0];
              logo.style.position = 'relative';
              logo.style.display = 'block';
              logo.style.textAlign = 'right';
              logo.style.padding = '8px 10px';
              logo.style.background = '#f8f8f8';
              logo.style.borderTop = '1px solid #e0e0e0';
            }
          });
        });
        
        observer.observe(document.body, {
          childList: true,
          subtree: true,
          attributes: true,
          attributeFilter: ['style', 'class']
        });
        
        // Also reposition on scroll
        window.addEventListener('scroll', () => {
          const pacContainers = document.querySelectorAll('.pac-container');
          if (pacContainers.length > 0 && addressInput) {
            const rect = addressInput.getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            
            pacContainers.forEach(container => {
              container.style.top = (rect.bottom + scrollTop + 2) + 'px';
              container.style.left = (rect.left + scrollLeft) + 'px';
            });
          }
        });
        
      } catch (error) {
        console.error('Error initializing autocomplete:', error);
      }

      google.maps.event.addListener(drawingManager, 'overlaycomplete', (event) => {
        let area = 0;
        let perimeter = 0;

        if (event.type === 'polygon') {
          const path = event.overlay.getPath();
          area = google.maps.geometry.spherical.computeArea(path);
          
          for (let i = 0; i < path.getLength(); i++) {
            const point1 = path.getAt(i);
            const point2 = path.getAt((i + 1) % path.getLength());
            perimeter += google.maps.geometry.spherical.computeDistanceBetween(point1, point2);
          }
        } else if (event.type === 'rectangle') {
          const bounds = event.overlay.getBounds();
          const ne = bounds.getNorthEast();
          const sw = bounds.getSouthWest();
          const nw = new google.maps.LatLng(ne.lat(), sw.lng());
          const se = new google.maps.LatLng(sw.lat(), ne.lng());
          
          area = google.maps.geometry.spherical.computeArea([ne, se, sw, nw]);
          
          const width = google.maps.geometry.spherical.computeDistanceBetween(nw, ne);
          const height = google.maps.geometry.spherical.computeDistanceBetween(nw, sw);
          perimeter = 2 * (width + height);
        }

        const sqFeet = area * 10.7639; // m¬≤ to ft¬≤
        const perimeterFeet = perimeter * 3.28084; // m to ft

        mapMeasurements.push({
          id: Date.now(),
          overlay: event.overlay,
          area: sqFeet,
          perimeter: perimeterFeet
        });

        updateMeasurementsDisplay();
      });
    }

    // Update measurements display
    function updateMeasurementsDisplay() {
      const display = document.getElementById('measurementsDisplay');
      const list = document.getElementById('measurementsList');
      const count = document.getElementById('measurementCount');
      
      if (mapMeasurements.length === 0) {
        display.style.display = 'none';
        return;
      }
      
      display.style.display = 'block';
      count.textContent = mapMeasurements.length;
      
      list.innerHTML = mapMeasurements.map((m, index) => `
        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 6px; margin-bottom: 8px; font-size: 13px;">
          <div>
            <strong>Area ${index + 1}:</strong> ${m.area.toFixed(2)} sq ft<br>
            <span style="font-size: 12px; opacity: 0.7;">Perimeter: ${m.perimeter.toFixed(2)} ft</span>
          </div>
          <button onclick="removeMeasurement(${index})" style="padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">‚úï</button>
        </div>
      `).join('');
      
      const totalArea = mapMeasurements.reduce((sum, m) => sum + m.area, 0);
      const totalPerimeter = mapMeasurements.reduce((sum, m) => sum + m.perimeter, 0);
      
      document.getElementById('totalArea').textContent = totalArea.toFixed(2);
      document.getElementById('totalPerimeter').textContent = totalPerimeter.toFixed(2);
    }

    // Apply measurements to dimension fields
    function applyMeasurements() {
      const totalArea = mapMeasurements.reduce((sum, m) => sum + m.area, 0);
      const totalPerimeter = mapMeasurements.reduce((sum, m) => sum + m.perimeter, 0);
      
      const category = materialCategory.value;
      
      if (category === 'sod') {
        const sqFtInput = document.getElementById('sqFt');
        if (sqFtInput) sqFtInput.value = totalArea.toFixed(2);
      } else {
        const estimatedSide = Math.sqrt(totalArea);
        const lengthInput = document.getElementById('length');
        const widthInput = document.getElementById('width');
        if (lengthInput) lengthInput.value = estimatedSide.toFixed(2);
        if (widthInput) widthInput.value = estimatedSide.toFixed(2);
      }
      
      // Apply perimeter to edging if enabled
      if (includeEdging.checked) {
        edgingLinearFt.value = totalPerimeter.toFixed(2);
      }
      
      calculate();
      alert('Measurements applied to dimensions!');
    }

    // Remove a measurement
    function removeMeasurement(index) {
      const measurement = mapMeasurements[index];
      if (measurement && measurement.overlay) {
        measurement.overlay.setMap(null);
      }
      mapMeasurements.splice(index, 1);
      updateMeasurementsDisplay();
    }

    // Clear all measurements
    function clearAllMeasurements() {
      mapMeasurements.forEach(m => {
        if (m.overlay) m.overlay.setMap(null);
      });
      mapMeasurements = [];
      updateMeasurementsDisplay();
    }

    // Search for address and center map (manual search or autocomplete fallback)
    function searchAddress() {
      const address = document.getElementById('addressSearch').value;
      
      if (!address.trim()) {
        alert('Please enter an address');
        return;
      }
      
      if (!map) {
        alert('Please wait for the map to load');
        return;
      }
      
      const geocoder = new google.maps.Geocoder();
      
      // Bias to Brevard County
      geocoder.geocode({ 
        address: address,
        componentRestrictions: {
          country: 'US',
          administrativeArea: 'FL'
        }
      }, (results, status) => {
        if (status === 'OK') {
          // Auto-fill property address in Project Details
          const propertyAddressInput = document.getElementById('propertyAddress');
          if (propertyAddressInput && results[0].formatted_address) {
            propertyAddressInput.value = results[0].formatted_address;
          }
          
          map.setCenter(results[0].geometry.location);
          map.setZoom(19); // Closer zoom for property view
          
          // Remove old location marker if exists
          if (locationMarker) {
            locationMarker.setMap(null);
          }
          
          // Add persistent RED marker at the searched location
          locationMarker = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location,
            animation: google.maps.Animation.DROP,
            icon: {
              url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
            },
            title: results[0].formatted_address || 'Property Location'
          });
        } else {
          alert('Address not found. Please try:\n‚Ä¢ Selecting from dropdown suggestions as you type\n‚Ä¢ Format: "123 Main St, Titusville, FL"');
        }
      });
    }

    function calculate() {
      const category = materialCategory.value;
      const selectedMaterialName = materialType.value;
      const material = MATERIALS[category].find(m => m.name === selectedMaterialName);
      
      if (!material) return;

      let materialCost = 0;
      let cubicYards = 0;
      let cubicFeet = 0;
      let totalSqFt = 0;
      let totalLinearFt = 0;

      if (category === 'sod') {
        const sqFt = parseFloat(document.getElementById('sqFt')?.value || 0);
        totalSqFt = sqFt;
        materialCost = sqFt * material.pricePerSqFt;
      } else {
        const length = parseFloat(document.getElementById('length')?.value || 0);
        const width = parseFloat(document.getElementById('width')?.value || 0);
        const depth = parseFloat(document.getElementById('depth')?.value || 1);
        
        totalSqFt = length * width;
        totalLinearFt = length;
        cubicFeet = (length * width * depth) / 12;
        cubicYards = cubicFeet / 27;
        
        materialCost = cubicYards * material.pricePerYard;
      }

      const geoTextileCost = includeGeoTextile.checked 
        ? (parseFloat(geoTextileLinearFt.value) || 0) * ADDONS.geoTextile.pricePerLinearFt 
        : 0;
      const edgingCost = includeEdging.checked 
        ? (parseFloat(edgingLinearFt.value) || 0) * ADDONS.edging.pricePerLinearFt 
        : 0;
      const addOnsCost = geoTextileCost + edgingCost;

      const laborCost = (parseFloat(document.getElementById('laborHours').value) || 0) 
        * (parseFloat(document.getElementById('laborRate').value) || 0);
      
      // Calculate equipment costs from rows
      const equipmentCost = equipmentRows.reduce((sum, row) => sum + (row.cost || 0), 0);
      
      // Calculate additional materials costs with 10% markup
      const additionalMaterialsBase = additionalMaterialRows.reduce((sum, row) => sum + (row.cost || 0), 0);
      const additionalMaterialsMarkup = additionalMaterialsBase * 0.10;
      const additionalMaterialsCost = additionalMaterialsBase + additionalMaterialsMarkup;
      
      const delivery = parseFloat(document.getElementById('deliveryFee').value) || 0;
      const haul = parseFloat(document.getElementById('haulAway').value) || 0;

      const subtotal = materialCost + additionalMaterialsCost + addOnsCost + laborCost + equipmentCost + delivery + haul;
      const markupAmount = subtotal * (parseFloat(document.getElementById('markupPercent').value) / 100);
      const totalWithMarkup = subtotal + markupAmount;

      // Get target profit margin from slider
      const profitMarginSlider = document.getElementById('profitMarginSlider');
      const targetMarginPercent = profitMarginSlider ? parseFloat(profitMarginSlider.value) : 40;
      const targetMargin = targetMarginPercent / 100; // Convert to decimal
      const ccFeeRate = 0.03; // 3% CC fee
      
      // Calculate to maintain target profit margin AFTER 3% CC fee
      // Formula: FinalPrice = (Costs) / (1 - targetMargin - ccFeeRate)
      // This ensures: (FinalPrice - Costs - CCFee) / FinalPrice = targetMargin
      const recommendedPrice = totalWithMarkup / (1 - targetMargin - ccFeeRate);
      const ccFee = recommendedPrice * ccFeeRate;
      const targetProfit = recommendedPrice - totalWithMarkup - ccFee;
      const profitMargin = (targetProfit / recommendedPrice) * 100;
      const subtotalWithProfit = recommendedPrice - ccFee;

      displaySummary({
        materialCost,
        additionalMaterialsBase,
        additionalMaterialsMarkup,
        additionalMaterialsCost,
        additionalMaterials: additionalMaterialRows.filter(r => r.description && r.cost > 0),
        addOnsCost,
        geoTextileCost,
        edgingCost,
        laborCost,
        equipmentCost: equipmentCost,
        equipmentRows: equipmentRows.filter(r => r.description && r.cost > 0),
        deliveryFee: delivery,
        haulAway: haul,
        subtotal,
        markupAmount,
        totalWithMarkup,
        targetProfit,
        subtotalWithProfit,
        ccFee,
        recommendedPrice,
        profitMargin,
        targetMarginPercent,
        cubicYards,
        cubicFeet,
        totalSqFt,
        totalLinearFt,
        category,
        materialName: selectedMaterialName
      });
    }

    function displaySummary(estimate) {
      const targetGoal = estimate.targetMarginPercent || 40;
      const meetsGoal = estimate.profitMargin >= (targetGoal - 0.5); // Allow 0.5% tolerance
      
      summaryContent.innerHTML = `
        <!-- Measurements -->
        <div class="info-box">
          <h3>üìè Measurements</h3>
          ${estimate.category !== 'sod' ? `
            <div class="info-row">
              <span>Area:</span>
              <span>${estimate.totalSqFt.toFixed(2)} sq ft</span>
            </div>
            <div class="info-row">
              <span>Volume:</span>
              <span>${estimate.cubicYards.toFixed(2)} cu yd</span>
            </div>
            <div class="info-row">
              <span>Cubic Feet:</span>
              <span>${estimate.cubicFeet.toFixed(2)} cu ft</span>
            </div>
          ` : `
            <div class="info-row">
              <span>Area:</span>
              <span>${estimate.totalSqFt.toFixed(2)} sq ft</span>
            </div>
          `}
        </div>

        <!-- Cost Breakdown -->
        <div class="info-box" style="background: rgba(0, 0, 0, 0.3);">
          <h3>üí∞ Cost Breakdown</h3>
          <div class="info-row">
            <span>Primary Material:</span>
            <span>${formatCurrency(estimate.materialCost)}</span>
          </div>
          ${estimate.additionalMaterialsCost > 0 ? `
            ${estimate.additionalMaterials && estimate.additionalMaterials.length > 0 ? `
              <div style="margin-bottom: 8px;">
                ${estimate.additionalMaterials.map(m => `
                  <div style="display: flex; justify-content: space-between; font-size: 13px; color: #2c3e50; margin-bottom: 4px;">
                    <span>‚Ä¢ ${m.description}</span>
                    <span>${formatCurrency(m.cost)}</span>
                  </div>
                `).join('')}
              </div>
            ` : ''}
            <div class="info-row" style="margin-left: 16px; font-size: 12px; opacity: 0.8;">
              <span>Materials Subtotal:</span>
              <span>${formatCurrency(estimate.additionalMaterialsBase)}</span>
            </div>
            <div class="info-row" style="margin-left: 16px; font-size: 12px; opacity: 0.8;">
              <span>10% Markup:</span>
              <span>${formatCurrency(estimate.additionalMaterialsMarkup)}</span>
            </div>
            <div class="info-row">
              <span>Additional Materials Total:</span>
              <span>${formatCurrency(estimate.additionalMaterialsCost)}</span>
            </div>
          ` : ''}
          ${estimate.addOnsCost > 0 ? `
            <div class="info-row">
              <span>Add-ons:</span>
              <span>${formatCurrency(estimate.addOnsCost)}</span>
            </div>
          ` : ''}
          ${estimate.laborCost > 0 ? `
            <div class="info-row">
              <span>Labor:</span>
              <span>${formatCurrency(estimate.laborCost)}</span>
            </div>
          ` : ''}
          ${estimate.equipmentCost > 0 ? `
            <div class="info-row">
              <span>Equipment Total:</span>
              <span>${formatCurrency(estimate.equipmentCost)}</span>
            </div>
            ${estimate.equipmentRows && estimate.equipmentRows.length > 0 ? `
              <div style="margin-left: 16px; margin-bottom: 8px;">
                ${estimate.equipmentRows.map(e => `
                  <div style="display: flex; justify-content: space-between; font-size: 12px; color: #7f8c8d; margin-bottom: 4px;">
                    <span>‚Ä¢ ${e.description}</span>
                    <span>${formatCurrency(e.cost)}</span>
                  </div>
                `).join('')}
              </div>
            ` : ''}
          ` : ''}
          ${estimate.deliveryFee > 0 ? `
            <div class="info-row">
              <span>Delivery:</span>
              <span>${formatCurrency(estimate.deliveryFee)}</span>
            </div>
          ` : ''}
          ${estimate.haulAway > 0 ? `
            <div class="info-row">
              <span>Haul Away:</span>
              <span>${formatCurrency(estimate.haulAway)}</span>
            </div>
          ` : ''}
          <div class="info-row divider" style="font-weight: 700;">
            <span>Subtotal:</span>
            <span>${formatCurrency(estimate.subtotal)}</span>
          </div>
          ${estimate.markupAmount > 0 ? `
            <div class="info-row">
              <span>Markup:</span>
              <span>${formatCurrency(estimate.markupAmount)}</span>
            </div>
          ` : ''}
          <div class="info-row" style="font-weight: 700; margin-top: 8px;">
            <span>Total with Markup:</span>
            <span>${formatCurrency(estimate.totalWithMarkup)}</span>
          </div>
        </div>

        <!-- Pricing Recommendation -->
        <div class="price-box ${meetsGoal ? 'success' : 'warning'}">
          <h3>üéØ Pricing Recommendation</h3>
          <div class="big-price">${formatCurrency(estimate.recommendedPrice)}</div>
          <div style="font-size: 13px; margin-bottom: 12px;">
            <div style="opacity: 0.8; margin-bottom: 4px;">Subtotal with profit: ${formatCurrency(estimate.subtotalWithProfit)}</div>
            <div style="opacity: 0.8;">+ 3% CC Fee: ${formatCurrency(estimate.ccFee)}</div>
          </div>
          <div style="font-size: 13px; opacity: 0.9; margin-bottom: 12px;">
            Target profit margin: ${estimate.profitMargin.toFixed(1)}%
          </div>
          <div class="status-badge">
            ${meetsGoal 
              ? `‚úì This project meets the ${targetGoal}% profit margin goal`
              : `‚ö† This project is below the ${targetGoal}% profit margin goal`
            }
          </div>
          <div style="font-size: 12px; opacity: 0.7;">
            Expected profit: ${formatCurrency(estimate.targetProfit)}
          </div>
        </div>

        <!-- Download Button -->
        <button onclick="downloadPDF()" style="background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%); border: none;">
          üìÑ Download PDF Report
        </button>
      `;
    }

    function downloadEstimate() {
      const projectName = document.getElementById('projectName').value || 'landscape';
      const projectType = document.getElementById('projectType').value || '';
      
      // Recalculate to get current values
      calculate();
      
      const report = `LANDSCAPING PROJECT ESTIMATE
${projectName ? `Project: ${projectName}` : ''}
${projectType ? `Type: ${projectType}` : ''}
Generated: ${new Date().toLocaleDateString()}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

See estimate details in the interface above.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;

      const blob = new Blob([report], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `estimate-${projectName}-${Date.now()}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const projectName = document.getElementById('projectName').value || 'Landscape Project';
      const propertyAddress = document.getElementById('propertyAddress').value || '';
      const projectType = document.getElementById('projectType').value || '';
      
      // Get current estimate data from the summary
      const summaryDiv = document.getElementById('summaryContent');
      if (!summaryDiv.innerHTML) {
        alert('Please complete the estimate first!');
        return;
      }
      
      // Header
      doc.setFontSize(20);
      doc.setFont(undefined, 'bold');
      doc.text('WS LAWN CARE', 105, 20, { align: 'center' });
      
      doc.setFontSize(16);
      doc.text('PROJECT ESTIMATE', 105, 30, { align: 'center' });
      
      // Project Info
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 45);
      doc.text(`Project: ${projectName}`, 20, 52);
      
      let yPos = 59;
      if (propertyAddress) {
        doc.text(`Property: ${propertyAddress}`, 20, yPos);
        yPos += 7;
      }
      if (projectType) {
        doc.text(`Type: ${projectType}`, 20, yPos);
        yPos += 7;
      }
      
      doc.line(20, yPos + 6, 190, yPos + 6);
      
      yPos += 16;
      
      // Get data from current estimate calculation
      const category = document.getElementById('materialCategory').value;
      const materialName = document.getElementById('materialType').value;
      
      // Material Selection
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.text('MATERIAL SELECTION', 20, yPos);
      yPos += 7;
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text(`Primary Material: ${materialName}`, 25, yPos);
      yPos += 7;
      
      // Dimensions
      if (category === 'sod') {
        const sqFt = document.getElementById('sqFt')?.value || 0;
        doc.text(`Area: ${parseFloat(sqFt).toFixed(2)} sq ft`, 25, yPos);
        yPos += 7;
      } else {
        const length = document.getElementById('length')?.value || 0;
        const width = document.getElementById('width')?.value || 0;
        const depth = document.getElementById('depth')?.value || 1;
        doc.text(`Dimensions: ${length}' L x ${width}' W x ${depth}" D`, 25, yPos);
        yPos += 7;
      }
      
      yPos += 5;
      
      // Additional Materials
      if (additionalMaterialRows.length > 0) {
        const filledMaterials = additionalMaterialRows.filter(r => r.description && r.cost > 0);
        if (filledMaterials.length > 0) {
          doc.setFont(undefined, 'bold');
          doc.text('ADDITIONAL MATERIALS', 20, yPos);
          yPos += 7;
          doc.setFont(undefined, 'normal');
          
          filledMaterials.forEach(m => {
            doc.text(`${m.description}`, 25, yPos);
            doc.text(`$${m.cost.toFixed(2)}`, 170, yPos, { align: 'right' });
            yPos += 6;
          });
          yPos += 3;
        }
      }
      
      // Equipment
      if (equipmentRows.length > 0) {
        const filledEquipment = equipmentRows.filter(r => r.description && r.cost > 0);
        if (filledEquipment.length > 0) {
          doc.setFont(undefined, 'bold');
          doc.text('EQUIPMENT', 20, yPos);
          yPos += 7;
          doc.setFont(undefined, 'normal');
          
          filledEquipment.forEach(e => {
            doc.text(`${e.description}`, 25, yPos);
            doc.text(`$${e.cost.toFixed(2)}`, 170, yPos, { align: 'right' });
            yPos += 6;
          });
          yPos += 3;
        }
      }
      
      // Add-ons
      const hasGeoTextile = document.getElementById('includeGeoTextile').checked;
      const hasEdging = document.getElementById('includeEdging').checked;
      
      if (hasGeoTextile || hasEdging) {
        doc.setFont(undefined, 'bold');
        doc.text('ADD-ONS', 20, yPos);
        yPos += 7;
        doc.setFont(undefined, 'normal');
        
        if (hasGeoTextile) {
          const geoFt = document.getElementById('geoTextileLinearFt').value || 0;
          const geoCost = parseFloat(geoFt) * 1.20;
          doc.text(`Geo Textile Fabric (${geoFt} ft)`, 25, yPos);
          doc.text(`$${geoCost.toFixed(2)}`, 170, yPos, { align: 'right' });
          yPos += 6;
        }
        
        if (hasEdging) {
          const edgeFt = document.getElementById('edgingLinearFt').value || 0;
          const edgeCost = parseFloat(edgeFt) * 5.00;
          doc.text(`Composite Edging (${edgeFt} ft)`, 25, yPos);
          doc.text(`$${edgeCost.toFixed(2)}`, 170, yPos, { align: 'right' });
          yPos += 6;
        }
        yPos += 3;
      }
      
      // Check if we need a new page
      if (yPos > 240) {
        doc.addPage();
        yPos = 20;
      }
      
      // Labor
      const laborHours = document.getElementById('laborHours').value || 0;
      const laborRate = document.getElementById('laborRate').value || 91;
      if (parseFloat(laborHours) > 0) {
        doc.setFont(undefined, 'bold');
        doc.text('LABOR', 20, yPos);
        yPos += 7;
        doc.setFont(undefined, 'normal');
        doc.text(`${laborHours} hours @ $${laborRate}/hr`, 25, yPos);
        const laborCost = parseFloat(laborHours) * parseFloat(laborRate);
        doc.text(`$${laborCost.toFixed(2)}`, 170, yPos, { align: 'right' });
        yPos += 10;
      }
      
      // Get final pricing from summary (this ensures accuracy)
      const priceElement = document.querySelector('.big-price');
      const finalPrice = priceElement ? priceElement.textContent : '$0.00';
      
      const profitElement = document.querySelector('.price-box .status-badge').previousElementSibling;
      const profitMarginText = profitElement ? profitElement.textContent : '';
      const profitMatch = profitMarginText.match(/(\d+\.\d+)%/);
      const profitMargin = profitMatch ? profitMatch[1] : '0';
      
      yPos += 5;
      doc.line(20, yPos, 190, yPos);
      yPos += 10;
      
      // Final Pricing
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.text('TOTAL PRICE', 20, yPos);
      doc.text(finalPrice, 190, yPos, { align: 'right' });
      yPos += 10;
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text(`Includes 3% credit card processing fee`, 25, yPos);
      yPos += 6;
      doc.text(`Target profit margin: ${profitMargin}%`, 25, yPos);
      yPos += 15;
      
      // Footer
      doc.line(20, yPos, 190, yPos);
      yPos += 7;
      doc.setFontSize(9);
      doc.text('Thank you for choosing WS Lawn Care!', 105, yPos, { align: 'center' });
      yPos += 5;
      doc.text('Professional Landscaping Services - Titusville, FL', 105, yPos, { align: 'center' });
      
      // Save
      doc.save(`WS-Estimate-${projectName.replace(/\s+/g, '-')}-${Date.now()}.pdf`);
    }

    // Initialize on load
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
